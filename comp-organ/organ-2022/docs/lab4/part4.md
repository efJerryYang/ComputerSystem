# 实验原理

### Cache的结构

Cache由存储体和控制机构两大主要部分构成。

#### 1 **Cache的存储体**

 <center><img src="../s4-1.png" width = 550></center>   

Ø 有效位（Valid）：标识该行内存储的数据是否有效，未装入任何数据之前无效。

Ø 标记（Tag）：用以唯一地标识某个地址，判断是否访问命中。

Ø 数据域（Data）：连续存储的k个相邻的在主存中连续的数据。

**映射机制**

如上所示的地址映射机制，低2位为字块内偏移，代表一个Cache行存储有4个字节。中间10位为Cache字块地址，代表Cache有1024个Cache行。高20位为Tag，用以唯一地标识某个主存地址，与Cache中的标记位比对，判断是否访问命中。

**地址分解**

 <center><img src="../s4-2.png" width = 550></center>   

例如，我们系统的主存容量为256KB，则主存地址宽度为18位；我们设计Cache每个字块中存储4个字节，则每个块中需要用2位去寻址相应的字节；Cache容量为256行（256*4B=1024B），且设计的方式是直接相联，则Cache字块地址为8位；剩余的18-8-2=8位，则作为Tag使用。此时，我们即完成了地址的分解工作。

如上图所示，一个典型的直接映射Cache访问主要完成几项工作：

Ø Cache寻址：根据主存地址中的Cache索引，选出对应的Cache块（行）

Ø 标记比对：主存中的标记位和取出行中的标记位对比，加上Valid位，判断是否命中

Ø 选出数据：如果命中，根据地址的低位偏移，在读出的Cache Line的数据域中，选择相应的数据，回送给主设备，并采取相应的机制通知主设备，在本次实验中，我们要求拉高Cache模块的hit信号，同时将数据输出到data_out上。

Ø 缺失处理：如果不命中的话，还需要进行缺失的处理，在下一部分将会提到。

#### 2 控制机构

**缺失处理机制**

当Cache的访问发生缺失时，应要有相应的机制，确定缺失的位置，并向下一级存储器发出读字块的请求。

**缺失动作**

在缺失时，Cache向下一级存储器（本实验中为mem_wrap）发起读请求，请求读取4个连续存储的字，待下级存储器响应后，将返回的数据采集、打上相应的标签，然后写入自身的存储体中。

**实现原理**

在时序电路中，如果要执行顺序发生的动作，并带有条件跳转，状态机是通用的做法。我们使用状态机生成控制信号，对数据通路进行操纵，从而达到处理各种情况的目的。