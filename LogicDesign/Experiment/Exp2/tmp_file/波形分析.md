## 实验2 计数器设计 仿真波形分析

### flowing_water_lights

#### 仿真波形

![2021-11-14](.\img\2021-11-14.png)

#### 波形分析

flowing_water_lights实验是实现流水灯：

* 当点按一次button启动流水灯之后，led的第0号位置点亮，每过CNT_MAX个时钟周期亮灯位置左移一位，当移动到7号位置时，重新从第0号位置亮灯。
* 当点按一次rst重置流水灯后，流水灯停止工作，led均不亮，再点按下button后led重新从0号位置开始工作。
* on_button，当点按过一次button且在按下rst前，on_button设置为1，表明流水灯正处在工作状态，在此条件下计数器才工作。
* cnt，通过计数器CNT_MAX时钟周期来达到控制每个led亮灯时间。

仿真测试通过，在仿真测试中，CNT_MAX取值为32'd4。在上板时，CNT_MAX取值为32'd1_0000_0000，上板结果正确。

| clk(ns) | rst  | button  | on_button | led(hex)   | led(bin)    | 是否与期望相同 |
| ------- | ---- | ------- | --------- | ---------- | ----------- | -------------- |
| 0-20    | 1    | 0       | 0         | 8'h0       | 8'b00000000 | 是             |
| 25-65   | 0    | 0=>1=>0 | 0=>1      | 8'h0=>8'h1 | 8'b00000001 | 是             |
| 65-105  | 0    | 0       | 1         | 8'h2       | 8'b00000010 | 是             |
| 105-145 | 0    | 0       | 1         | 8'h4       | 8'b00000100 | 是             |
| 145-185 | 0    | 0       | 1         | 8'h8       | 8'b00001000 | 是             |
| 185-225 | 0    | 0=>1=>0 | 1         | 8'h10      | 8'b00010000 | 是             |
| 225-265 | 0    | 0       | 1         | 8'h20      | 8'b00100000 | 是             |
| 265-305 | 0    | 0       | 1         | 8'h40      | 8'b01000000 | 是             |
| 305-345 | 0    | 0       | 1         | 8'h80      | 8'b10000000 | 是             |
| 345-385 | 0    | 0=>1=>0 | 1         | 8'h1       | 8'b00000001 | 是             |
| ......  |      |         |           |            |             |                |

以上为一个运行周期的结果。可以看到，仿真时每经过40ns即4个时钟周期，led完成一次循环移位，总亮灯数目始终为1，除此外，也实现了在仅仅对button进行点按时也根据on_button对流水灯工作进行控制，说明该模块实现了流水灯的功能。



### holiday_lights

#### 仿真波形

![2021-11-14 (2)](.\img\2021-11-14 (2).png)

![2021-11-14 (4)](.\img\2021-11-14 (4).png)

![2021-11-14 (7)](.\img\2021-11-14 (7).png)

#### 波形分析

holiday_lights是实现节日彩灯：

* switch: 在流水灯工作的基础上，实现通过switch开关控制亮灯的数目，支持动态切换，即在工作时可以通过更改switch开关的值来修改同时亮灯的数目（对于增大switch值和减小switch值均支持）。switch值+1为总亮灯个数，故最多亮灯数目为8。
* rst和button: 在工作过程中点按rst使得节日彩灯led熄灭，在led熄灭时点按button能使led重新开始工作。
* on_button: 在点按button后on_button设置为1，代表节日彩灯开始工作，在点按rst之后on_button设置为0，代表节日彩灯被重置，停止工作。
* cnt: 在on_button为1时，根据时钟周期进行计数，当计数器cnt < CNT_MAX时，计数+1，否则清零重新计数
* pos: 用于记录第一个亮灯位置的下标，每次点亮pos及其以左的switch个led灯，当switch为0时只亮1pos位置的灯，当pos+switch超出led控制的下标范围时，点亮从起点开始的超出的个数个led灯。这样动态切换时相当于是基于pos处的灯点亮它以后的switch个数个led灯。

仿真测试通过，在仿真测试中，CNT_MAX取值为32'd4。在上板时，CNT_MAX取值为32'd1_0000_0000，上板结果正确。switch动态切换无异常。

| clk(ns) | rst  | button  | but_dly | on_button | switch | pos        | led(hex)              | led(bin)                        | 结果 |
| ------- | ---- | ------- | ------- | --------- | ------ | ---------- | --------------------- | ------------------------------- | ---- |
| 0-20    | 1    | 0       |         | 0         | 0      | 0          | 0                     | 0                               | 是   |
| 25-35   | 0    | 0=>1=>0 | 0       | 0         | 0      | 0          | 0                     | 0                               | 是   |
| 35-55   | 0    | 0       | 0=>1=>0 | 0=>1      | 0      | 0          | 0=>32'h1              | 0=>32'b1                        | 是   |
| 55-195  | 0    | 0=>1=>0 | 0       | 1         | 0      | 0=>1=>2=>3 | 32'h1=>32'h8          | 32'b1=>32'b1000                 | 是   |
| 195-245 | 0    | 0       | 0=>1=>0 | 1         | 1      | 3=>4=>5    | 32'h8=>32'h10=>32'h30 | 32'b1000=>32'b10000=>32'b110000 | 是   |
| 245-405 | 0    | /       | /       | 1         | 1=>2   | 5=>10      | 32'h30=>32'h700       | 32'b110000=>32'b11100000000     | 是   |
| ......  |      |         |         |           |        |            |                       |                                 |      |

以上为仿真中2次切换switch的结果，led在可接受的延迟下实现了实时的切换，从switch=0时点亮1盏灯到switch=2时点亮3盏灯，说明该模块实现了节日彩灯的功能，并做到了实时的切换。除此以外，在上板操作时经验证也支持switch值任意变动的切换，即既可以增大也可以减小switch的值。



本次实验中，通过对原代码冗杂结构的修改，初步适应了硬件编程的并行思想，提高了对硬件编程的认识。

